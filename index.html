<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>301 äº¤éŸ¿æ¨‚ç« ï¼šç­ç´šå¹¹éƒ¨æˆè·å…¸ç¦®</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --paper: #f4eee1;
            --ink: #2c3e50;
            --gold: #b8860b;
            --burgundy: #800020;
            --pencil-gray: #666666;
        }

        body {
            background-color: var(--paper);
            background-image: 
                linear-gradient(rgba(244, 238, 225, 0.85), rgba(244, 238, 225, 0.85)),
                url('https://www.transparenttextures.com/patterns/aged-paper.png'),
                url('https://www.transparenttextures.com/patterns/gray-paper.png');
            color: var(--ink);
            font-family: 'Noto Serif TC', serif;
            margin: 0; padding: 0;
            line-height: 1.6;
        }

        /* ç´ æäº”ç·šè­œèƒŒæ™¯ */
        .sketch-staff {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: repeating-linear-gradient(
                transparent, transparent 40px,
                rgba(102, 102, 102, 0.08) 40px, rgba(102, 102, 102, 0.08) 41px,
                transparent 41px, transparent 45px,
                rgba(102, 102, 102, 0.08) 45px, rgba(102, 102, 102, 0.08) 46px,
                transparent 46px, transparent 50px,
                rgba(102, 102, 102, 0.08) 50px, rgba(102, 102, 102, 0.08) 51px,
                transparent 51px, transparent 55px,
                rgba(102, 102, 102, 0.08) 55px, rgba(102, 102, 102, 0.08) 56px,
                transparent 56px, transparent 60px,
                rgba(102, 102, 102, 0.08) 60px, rgba(102, 102, 102, 0.08) 61px
            );
            pointer-events: none; z-index: -1;
        }

        header { padding: 50px 20px; text-align: center; border-bottom: 2px solid var(--burgundy); background: rgba(255, 255, 255, 0.1); }
        h1 { font-size: 2.5rem; letter-spacing: 10px; margin: 0; color: var(--burgundy); }
        .subtitle { font-size: 0.9rem; letter-spacing: 3px; color: var(--gold); margin-top: 5px; text-transform: uppercase; }

        .container { max-width: 800px; margin: 30px auto; padding: 0 20px; }
        .classic-card { background: rgba(255, 250, 240, 0.95); border: 1px solid var(--gold); padding: 35px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); position: relative; }

        /* æŠ•ç¥¨é …ç›® */
        .vote-item { margin-bottom: 40px; border-bottom: 1px dashed #d1c7ac; padding-bottom: 25px; }
        .student-name { font-size: 1.4rem; color: var(--burgundy); font-weight: bold; margin-bottom: 10px; display: block; }
        .trait-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 8px; transition: 0.3s; }
        
        .trait-btn { background: transparent; border: 1px solid #d1c7ac; padding: 6px; cursor: pointer; font-family: inherit; font-size: 0.85rem; color: var(--pencil-gray); }
        .trait-btn.selected { background: var(--burgundy); color: white; border-color: var(--burgundy); }
        
        .blank-btn { border-color: #999; color: #666; font-style: italic; margin-bottom: 10px; cursor: pointer; background: none; padding: 5px 15px; font-family: inherit; }
        .blank-btn.active-blank { background-color: #eee; color: #999; border-style: dashed; }

        /* æ­æ›‰ç•«é¢ */
        .reveal-title { font-size: 2.2rem; color: var(--burgundy); border-bottom: 2px solid var(--gold); display: inline-block; padding: 0 30px; margin-bottom: 30px; }
        .chart-box { background: white; border: 1px solid #eee; padding: 15px; width: 260px; margin-bottom: 20px; }
        .cand-name { font-weight: bold; color: var(--burgundy); font-size: 1.3rem; margin-bottom: 5px; }

        .btn-action { width: 100%; padding: 18px; background: var(--burgundy); color: white; border: none; font-size: 1.1rem; letter-spacing: 4px; cursor: pointer; margin-top: 20px; font-family: inherit; }
        .hidden { display: none; }
        .loading-text { font-size: 1.2rem; color: var(--pencil-gray); padding: 50px; }
    </style>
</head>
<body>

<div class="sketch-staff"></div>

<header>
    <h1>301 äº¤éŸ¿æ¨‚ç« </h1>
    <div class="subtitle">Class 301 Musician Cadre Appointment Ceremony</div>
</header>

<div class="container">
    
    <div id="view-vote" class="classic-card">
        <h2 style="text-align:center; font-weight: normal; letter-spacing: 3px;">å…¨é«”æˆå“¡ç‰¹è³ªè©•åƒ¹</h2>
        <p style="text-align:center; font-style: italic; color: var(--pencil-gray); font-size: 0.9rem;">è«‹é‡å°æ¯ä½æˆå“¡é¸å– 2 å€‹ç‰¹è³ªï¼Œæˆ–æ¨™è¨˜ç‚ºæš«ç„¡å»ºè­°</p>
        
        <div style="margin: 20px 0; text-align:center;">
            <input type="text" id="voter-name" placeholder="è«‹ç°½å (æ‚¨çš„å§“å)" style="background:transparent; border:none; border-bottom: 1px solid var(--gold); padding: 8px; text-align:center; width: 180px; font-family: inherit; font-size: 1.1rem;">
        </div>

        <div id="student-list"></div>
        <button class="btn-action" onclick="submitVotes()">å¯†å°ä¸¦æäº¤ âœ‰ï¸</button>
    </div>

    <div id="view-reveal" class="hidden">
        <div class="classic-card" style="text-align: center;">
            <div id="reveal-content">
                <div class="loading-text">æº–å‚™é€²å…¥æˆè·å…¸ç¦®...</div>
            </div>
            <button id="next-btn" class="btn-action" style="width:auto; padding: 15px 50px; display:none;" onclick="showNextOfficer()">æ­æ›‰ä¸‹ä¸€è·ä½ â¯</button>
        </div>
    </div>

    <div style="text-align:center; margin-top: 50px; opacity: 0.1;">
        <button onclick="toggleMode()" style="background:none; border:none; cursor:pointer;">åˆ‡æ›æ¨¡å¼</button>
    </div>
</div>

<script>
    // --- æ ¸å¿ƒè³‡æ–™è¨­å®š ---
    const GAS_URL = "https://script.google.com/macros/s/AKfycbzBs1VLMICyOwIVJIOfRrfFQHAThOIBKdvib1dhDexSD893AYqpjD415QAOzG5poBJk/exec";

    const students = ["å®‰ç´„ç‘Ÿ", "å³ç¿æ©", "æ—å­å‹›", "æ—å®¶è‘¦", "å¼µè³´ç€šå¦‚", "é™³å°¹ç«£", "é»ƒéˆºæ£ ", "æ¥Šæ™ºèª ", "æ­ç¿”ç´œ", "ç‹äº®éˆ", "åŠ‰å“å¦¤", "å®‹å®›éœ–", "æ²ˆå­—æ¸", "æ—æ©ç¶º", "æ´ªä»¥çœŸ", "é¦¬èªæ‰", "é™³èŠŠç¾½", "é»ƒç³é›", "é»ƒè©©å©·"];
    const allTraits = ["è² è²¬", "æ¨‚è§€", "æœƒå”èª¿", "èªªè©±æœ‰æ¢ç†", "è®“äººæœæ°£", "ç´°å¿ƒ", "æº–æ™‚", "æœ‰è§€å¯ŸåŠ›", "å¯é ", "è¦ªåˆ‡", "æƒ…ç·’ç©©å®š", "åšäº‹æœ‰è¦åŠƒ", "å¿ƒæ™ºå …å®š", "åœ¨å°çš„æ™‚é–“åšå°çš„äº‹æƒ…", "æ­£å¸¸äººçš„ä¹¾æ·¨", "äººç·£ä¸éŒ¯", "é«”åŠ›å¥½", "æœ‰æ™‚é–“è§€å¿µ", "ç¾æ„Ÿä½³", "è¨˜æ€§å¥½", "å’Œè€å¸«çš„é—œä¿‚ä¸éŒ¯", "èªªåˆ°åšåˆ°", "è²¼å¿ƒ", "æœ‰ç¾¤çœ¾é­…åŠ›"];

    const officerOrder = [
        { job: "ç­é•·", traits: ["è² è²¬", "æ¨‚è§€", "æœƒå”èª¿", "èªªè©±æœ‰æ¢ç†", "è®“äººæœæ°£"] },
        { job: "å‰¯ç­é•·", traits: ["ç´°å¿ƒ", "æº–æ™‚", "æœ‰è§€å¯ŸåŠ›", "å¯é ", "è¦ªåˆ‡"] },
        { job: "é¢¨ç´€è‚¡é•·", traits: ["æƒ…ç·’ç©©å®š", "åšäº‹æœ‰è¦åŠƒ", "å¿ƒæ™ºå …å®š", "åœ¨å°çš„æ™‚é–“åšå°çš„äº‹æƒ…"] },
        { job: "å­¸è—è‚¡é•·", traits: ["ç¾æ„Ÿä½³", "è¨˜æ€§å¥½", "å’Œè€å¸«çš„é—œä¿‚ä¸éŒ¯", "è² è²¬"] },
        { job: "ç¸½å‹™è‚¡é•·", traits: ["ç´°å¿ƒ", "è² è²¬", "æœ‰æ™‚é–“è§€å¿µ", "è®“äººæœæ°£"] },
        { job: "åˆä½œè‚¡é•·", traits: ["é«”åŠ›å¥½", "æœ‰æ™‚é–“è§€å¿µ", "è² è²¬", "äººç·£ä¸éŒ¯"] },
        { job: "è¡›ç”Ÿè‚¡é•·", traits: ["æ­£å¸¸äººçš„ä¹¾æ·¨", "äººç·£ä¸éŒ¯", "é«”åŠ›å¥½", "æœ‰æ™‚é–“è§€å¿µ"] },
        { job: "åœ–è³‡è‚¡é•·", traits: ["èªªåˆ°åšåˆ°", "è² è²¬", "è¨˜æ€§å¥½"] },
        { job: "åº·æ¨‚è‚¡é•·", traits: ["æ¨‚è§€", "é«”åŠ›å¥½", "æœƒå”èª¿", "æœ‰ç¾¤çœ¾é­…åŠ›"] },
        { job: "è¼”å°è‚¡é•·", traits: ["ç´°å¿ƒ", "è²¼å¿ƒ", "è² è²¬", "æœ‰è§€å¯ŸåŠ›"] }
    ];

    let currentOfficerIdx = -1;
    let cachedVotes = [];

    // --- åˆå§‹åŒ–æŠ•ç¥¨åˆ—è¡¨ ---
    function init() {
        const container = document.getElementById('student-list');
        students.forEach(name => {
            const div = document.createElement('div');
            div.className = 'vote-item';
            div.innerHTML = `
                <span class="student-name">${name}</span>
                <button class="blank-btn" onclick="markBlank(this)">ğŸš« æš«ç„¡å»ºè­°ç‰¹è³ª (ç©ºç™½)</button>
                <div class="trait-grid" data-student="${name}">
                    ${allTraits.map(t => `<button class="trait-btn" onclick="toggleTrait(this)">${t}</button>`).join('')}
                </div>
            `;
            container.appendChild(div);
        });
    }

    function toggleTrait(btn) {
        const pool = btn.parentElement;
        const selected = pool.querySelectorAll('.selected');
        if (btn.classList.contains('selected')) {
            btn.classList.remove('selected');
        } else if (selected.length < 2) {
            btn.classList.add('selected');
        }
    }

    function markBlank(btn) {
        const pool = btn.nextElementSibling;
        const buttons = pool.querySelectorAll('.trait-btn');
        buttons.forEach(b => b.classList.remove('selected'));
        if (!btn.classList.contains('active-blank')) {
            btn.classList.add('active-blank');
            btn.innerHTML = "âœ– å·²æ¨™è¨˜ç‚ºç©ºç™½";
            pool.style.opacity = "0.3"; pool.style.pointerEvents = "none";
        } else {
            btn.classList.remove('active-blank');
            btn.innerHTML = "ğŸš« æš«ç„¡å»ºè­°ç‰¹è³ª (ç©ºç™½)";
            pool.style.opacity = "1"; pool.style.pointerEvents = "auto";
        }
    }

    async function submitVotes() {
        const voter = document.getElementById('voter-name').value;
        if (!voter) return alert("è«‹ç°½åä»¥ç¤ºè² è²¬ã€‚");
        const data = [];
        const items = document.querySelectorAll('.vote-item');
        for (let item of items) {
            const name = item.querySelector('.student-name').textContent;
            const isBlank = item.querySelector('.blank-btn').classList.contains('active-blank');
            const selected = item.querySelector('.trait-grid').querySelectorAll('.selected');
            if (!isBlank && selected.length < 2) return alert(`è«‹å®Œæˆå° ${name} çš„è©•åƒ¹ã€‚`);
            data.push({ target: name, t1: isBlank ? "ç„¡" : selected[0].textContent, t2: isBlank ? "ç„¡" : selected[1].textContent });
        }
        if(!confirm("ç¢ºèªæäº¤ï¼Ÿ")) return;
        try {
            await fetch(GAS_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ voter, votes: data }) });
            alert("æäº¤å®Œæˆï¼"); location.reload();
        } catch(e) { alert("æäº¤å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²å€ã€‚"); }
    }

    // --- æ­æ›‰é‚è¼¯ ---
    async function toggleMode() {
        document.getElementById('view-vote').classList.toggle('hidden');
        document.getElementById('view-reveal').classList.toggle('hidden');
        if(!document.getElementById('view-reveal').classList.contains('hidden')) {
            await fetchCloudData();
        }
    }

    async function fetchCloudData() {
        try {
            const res = await fetch(GAS_URL + "?action=getData");
            cachedVotes = await res.json();
            document.getElementById('reveal-content').innerHTML = "<h2>é›²ç«¯æ¨‚è­œå·²è®€å–å®Œæˆ</h2><p>å…¨ç­æŠ•ç¥¨æ•¸æ“šå·²å½™æ•´</p>";
            document.getElementById('next-btn').style.display = "inline-block";
        } catch(e) {
            document.getElementById('reveal-content').innerHTML = "<h2>æŠ“å–å¤±æ•—</h2><p>è«‹ç¢ºèª GAS æ˜¯å¦æœ‰ getData åŠŸèƒ½</p>";
        }
    }

    function showNextOfficer() {
        currentOfficerIdx++;
        if (currentOfficerIdx >= officerOrder.length) {
            document.getElementById('reveal-content').innerHTML = "<h1>å…¸ç¦®åœ“æ»¿çµæŸ</h1>";
            document.getElementById('next-btn').style.display = 'none';
            return;
        }

        const off = officerOrder[currentOfficerIdx];
        
        // è¨ˆç®—æ’å
        let rankings = students.map(name => {
            let score = 0;
            let detail = off.traits.map(t => {
                let count = cachedVotes.filter(v => v.target === name && (v.t1 === t || v.t2 === t)).length;
                score += count; return count;
            });
            return { name, score, detail };
        }).sort((a,b) => b.score - a.score);

        const top3 = rankings.slice(0, 3);
        const content = document.getElementById('reveal-content');
        content.innerHTML = `<div class="reveal-title">${off.job}</div><div style="display:flex; flex-wrap:wrap; justify-content:center; gap:20px;" id="chart-area"></div>`;

        top3.forEach((cand, i) => {
            const box = document.createElement('div');
            box.className = 'chart-box';
            box.innerHTML = `<div class="cand-name">${cand.name}</div><canvas id="c-${currentOfficerIdx}-${i}"></canvas>`;
            document.getElementById('chart-area').appendChild(box);
            
            setTimeout(() => {
                new Chart(document.getElementById(`c-${currentOfficerIdx}-${i}`), {
                    type: 'bar',
                    data: { labels: off.traits, datasets: [{ data: cand.detail, backgroundColor: '#800020' }] },
                    options: { indexAxis: 'y', plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true, ticks: {stepSize: 1} } } }
                });
            }, 50);
        });
    }

    init();
</script>
</body>
</html>